<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <title>Dashboard</title>
</head>

<style>
    body {

        font-family: 'Montserrat', sans-serif;
        padding: 25px;
    }

    /*--------------------------- HEADER ------------------------*/

    header {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        padding: 10px;
        border-bottom: 1px solid rgb(197, 197, 197);
    }

    .booklogo {
        width: 60px;
        height: 60px;
    }


    .headerContainer {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: end;
        text-align: center;
        padding-left: 50px;
        padding-right: 50px;
    }


    .headerButtonsContainers {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        width: 125px;
    }

    .signUpButton {
        font-family: 'Montseratt', sans-serif;
        cursor: pointer;
        font-size: medium;
        border: none;
        background-color: white;
        color: black;
        text-decoration: none;
        padding: 0px;
    }

    .signUpButton:hover {
        color: rgb(98, 0, 179);
    }

    /*--------------------------- CONTENT ------------------------*/

    .addBookSection {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: white;
        padding: 5px;
        border-radius: 15px;
        background-color: white;
    }

    .userNameTitle {
        color: rgb(98, 0, 179);
    }

    .addBooks {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background-color: rgb(98, 0, 179);
        color: white;
        border-radius: 16px;
        width: 50%;
        padding: 30px;
        box-shadow: 0 16px 35px rgba(0, 0, 0, 0.08);
        transition: box-shadow 0.3s ease;
    }

    .chartContainer {
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
        text-align: center;
        padding: 10px;
        box-shadow: 5px 5px 5px 5px rgba(0, 0, 0, 0.5);
    }

    .card {
        background-color: white;
        border-radius: 16px;
        padding: 30px;
        box-shadow: 0 12px 25px rgba(0, 0, 0, 0.05);
        transition: box-shadow 0.3s ease;
    }

    .card:hover {
        box-shadow: 0 16px 35px rgba(0, 0, 0, 0.08);
    }

    .statsDiv {
        padding: 100px;

    }

    table {
        width: 100%;
        border-collapse: collapse;
        border-radius: 25px;
        overflow: hidden;
    }

    thead {
        background-color: rgb(98, 0, 179);
        color: white;
    }

    th,
    td {
        padding: 14px;
        text-align: center;
        border-bottom: 1px solid #ddd;
    }

    th:first-child {
        border-top-left-radius: 15px;
    }

    th:last-child {
        border-top-right-radius: 15px;
    }

    tr:last-child td:first-child {
        border-bottom-left-radius: 15px;
    }

    tr:last-child td:last-child {
        border-bottom-right-radius: 15px;
    }

    tbody:hover {
        background-color: #f9fafb;
    }

    .addBookButtomDiv {
        display: flex;
        justify-content: center;
    }

    .addBookContentDiv {
        display: flex;
        flex-direction: row;
    }

    .addBookContentTitleContainer {
        display: flex;
        justify-content: end;
        width: 150px;
        padding: 10px;
    }

    .addBookContentContainer {
        display: flex;
        justify-content: start;
        padding: 10px;
    }

    .deleteButton {
        font-weight: bolder;
        width: 100%;
        height: 35px;
        font-size: small;
        color: rgb(98, 0, 179);
        background-color: white;
        border: 3px solid rgb(211, 211, 211);
        border-radius: 25px;
        cursor: pointer;
    }

    .formDialog {
        width: 85%;
        border: none;
        position: relative;
    }

    .deleteButton:hover {
        color: rgb(98, 0, 179);
        border: 3px solid rgb(98, 0, 179);
    }

    .hidden {
        display: none;
    }

    .inputTitle {
        font-weight: bold;
        font-size: medium;
    }

    .inputStyle {
        width: 300px;
        height: 10px;
        border: none;
        border-radius: 25px;
        padding: 10px;
    }

    .inputStyle:hover {
        border: none;
    }

    .selectStyle {
        width: 320px;
        height: 35px;
        border: none;
        border-radius: 15px;
        padding: 10px;
        color: black;
    }

    .buttonDiv {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .buttonStyle {
        font-weight: bolder;
        width: 250px;
        height: 70px;
        font-size: medium;
        color: rgb(98, 0, 179);
        background-color: white;
        border: 3px solid rgb(211, 211, 211);
        border-radius: 25px;
        cursor: pointer;
    }

    .buttonStyle:hover {
        color: white;
        border: 3px solid white;
        background-color: rgba(0, 0, 0, 0.2);
    }

    .chartTitleDiv {
        font-weight: bold;
        display: flex;
        justify-content: center;
    }

    .barsContainer {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 50px;
        border-color: black;
        border: 2px solid rgba(0, 0, 0, 0.8);
    }

    .recommendedBar {
        height: 100%;
        background-color: #00fff2;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        transition: height 0.3s;
    }

    .notRecommendedBar {
        height: 100%;
        background-color: #ff7b00;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        transition: height 0.3s;
    }
</style>

<body>

    <header>
        <div class="headerContainer"><img class="booklogo" src="\assets\logo.png" alt=""></div>
        <div class="headerContainer">
            <h1>Bookshelf</h1>
        </div>
        <div class="headerButtonsContainers">
            <button class="signUpButton" id="logoutButton">Log out</button>
            <a class="signUpButton" href="\views\profile.html">Profile</a>
        </div>
    </header>
    <br>
    <section class="contentSection">

        <h2 id="userNameTitle" class="userNameTitle"></h2>
        <section id="resp" class="card hidden">
            <h3>Readed books:</h3>
            <div id="tableContainer"></div>
        </section>
        <br>
        <div class="contentDiv"></div>
        <br>

        <div class="addBookButtomDiv">
            <button class="buttonStyle" id="buttonShow">ADD BOOK</button>
            <button class="buttonStyle" id="buttonHide">CANCEL</button>
        </div>

        <dialog id="formDialog" class="formDialog">
            <section class="addBookSection">
                <div class="addBooks">
                    <h4>Add book:</h4>
                    <form action="">
                        <div class="addBookContentDiv">
                            <div class="addBookContentTitleContainer">
                                <label class="inputTitle">Title:</label>
                            </div>
                            <div class="addBookContentContainer">
                                <input type="text" id="title" class="inputStyle" placeholder="title" maxlength="50"
                                    required autofocus>
                            </div>
                        </div>
                        <div class="addBookContentDiv">
                            <div class="addBookContentTitleContainer">
                                <label class="inputTitle">Author:</label>
                            </div>
                            <div class="addBookContentContainer">
                                <input type="text" id="author" class="inputStyle" placeholder="author" maxlength="25"
                                    required>
                            </div>
                        </div>
                        <div class="addBookContentDiv">
                            <div class="addBookContentTitleContainer">
                                <label class="inputTitle">Date of read:</label>
                            </div>
                            <div class="addBookContentContainer">
                                <input type="date" id="date" class="inputStyle" required>
                            </div>
                        </div>
                        <div class="addBookContentDiv">
                            <div class="addBookContentTitleContainer">
                                <label class="inputTitle">Number of pages:</label>
                            </div>
                            <div class="addBookContentContainer">
                                <input type="number" id="pages" class="inputStyle" maxlength="4" placeholder="000"
                                    required min="2" max="9999">
                            </div>
                        </div>
                        <div class="addBookContentDiv">
                            <div class="addBookContentTitleContainer">
                                <label class="inputTitle">To recommend:</label>
                            </div>
                            <div class="addBookContentContainer">
                                <select id="torecommend" class="selectStyle" required>
                                    <option value="Yes" selected>Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>
                        <br>
                        <div class="buttonDiv">
                            <input type="submit" value="ADD" class="buttonStyle">
                            <br>
                    </form>
                    <br>
                </div>
                </div>
            </section>
        </dialog>
        <br>
        </div>
    </section>
    <h4>Book Stats:</h4>
    <section class="chartContainer">
        <div class="statsDiv">
            <p id="totalBooksRead">Total books read: </p>
            <p id="averagePages">Average pages per book: </p>
        </div>
        <div class="statsDiv"></div>
        <div>
            <div class="chartTitleDiv">
                <p>Recommend vs Not Recommend</p>
            </div>
            <div id="chartContainer" class="barsContainer">
                <div id="recommendedBar" class="recommendedBar">
                </div>
                <div id="notRecommendedBar" class="notRecommendedBar">
                </div>
            </div>
        </div>
    </section>

</body>


<script>
    (() => {
        const App = (() => {

            const htmlElements = {
                logout: document.querySelector('#logoutButton'),
                userTitle: document.querySelector('#userNameTitle'),
                form: document.querySelector('form'),
                tableContainer: document.querySelector('section#resp #tableContainer'),
                resp: document.querySelector('section#resp'),
                avgPagesoutput: document.getElementById('averagePages'),
                totalBooksoutput: document.getElementById('totalBooksRead'),
                recommendationChart: document.getElementById('recommendationChart'),
                buttonShow: document.querySelector('#buttonShow'),
                buttonHide: document.querySelector('#buttonHide'),
                formDialog: document.querySelector("#formDialog"),
            }

            const methods = {

                printUserName() {

                    const User = JSON.parse(localStorage.getItem('login_success')) || []
                    const name = User.fullname
                    htmlElements.userTitle.innerHTML = `- Welcome ${name}!`
                },

                openDialog() {
                    formDialog.show()
                },

                hideDialog() {
                    formDialog.close()
                },

                generateRow(book) {

                    return `
          <tr>
            <td>${book.title}</td>
            <td>${book.author}</td>
            <td>${book.readdate}</td>
            <td>${book.pages}</td>
            <td>${book.torecommend}</td>
            <td><button class="deleteButton" data-title="${book.title}">Delete</button></td>
          </tr>`;
                },

                generateTable() {
                    const User = JSON.parse(localStorage.getItem('login_success')) || []
                    const username = User.username
                    const actualUserBooks = JSON.parse(localStorage.getItem(`${username}Books`))
                    let table = '';
                    actualUserBooks.forEach(book => {
                        table += methods.generateRow(book)

                    });

                    if (table === '') {
                        return `<p>No books registered yet</p>`
                    } else {
                        return `
              <table>
                <thead>
                  <tr>
                    <th>Title</th>
                    <th>Author</th>
                    <th>Date of read</th>
                    <th>Number of pages</th>
                    <th>To Recommend</th>
                    <th>-</th>
                  </tr>
                </thead>
                <tbody>
                  ${table}
                </tbody>
              </table>`;
                    }
                },

                removeRow(e) {
                    const button = e.target;
                    const titleToDelete = button.getAttribute('data-title')

                    const User = JSON.parse(localStorage.getItem('login_success')) || {};
                    const username = User.username;
                    let userBooks = JSON.parse(localStorage.getItem(`${username}Books`)) || [];

                    userBooks = userBooks.filter(book => book.title !== titleToDelete)

                    localStorage.setItem(`${username}Books`, JSON.stringify(userBooks))

                    e.target.closest('tr').remove();
                    methods.getAverage()
                    methods.getTotalBooks()
                    methods.generateChart()
                    alert("Book deleted!")
                },

                bindEvents() {
                    htmlElements.resp.querySelectorAll('button').forEach(b => {
                        b.addEventListener('click', methods.removeRow);
                    });
                },

                addBooks(title, author, date, pages, torecommend) {
                    const booktitle = title
                    const bookauthor = author
                    const bookreaddate = date
                    const bookpages = pages
                    const booktorecommend = torecommend

                    const User = JSON.parse(localStorage.getItem('login_success')) || false
                    const username = User.username

                    let userBooks = JSON.parse(localStorage.getItem(`${username}Books`)) || [];
                    const books = { title: booktitle, author: bookauthor, readdate: bookreaddate, pages: bookpages, torecommend: booktorecommend }
                    userBooks.push(books)
                    console.log(userBooks)
                    localStorage.setItem(`${username}Books`, JSON.stringify(userBooks))
                    alert("Your books has been updated!")
                    window.location.href = 'dashboard.html'
                },

                getAverage() {
                    const outPut = htmlElements.avgPagesoutput
                    const username = JSON.parse(localStorage.getItem('login_success'))?.username
                    const userBooks = JSON.parse(localStorage.getItem(`${username}Books`)) || []

                    const avgPages = userBooks.length
                        ? Math.round(userBooks.reduce((sum, book) => sum + (parseInt(book.pages) || 0), 0) / userBooks.length)
                        : 0

                    return outPut.textContent = `Average pages per book: ${avgPages}`

                },

                getTotalBooks() {
                    const outPut = htmlElements.totalBooksoutput
                    const username = JSON.parse(localStorage.getItem('login_success'))?.username
                    const userBooks = JSON.parse(localStorage.getItem(`${username}Books`)) || []

                    return outPut.textContent = `Total books read: ${userBooks.length}`
                },

                displayRecommendedBar() {
                    const { recommendedPercent } = methods.getRecommendationStats()
                    const bar = document.getElementById('recommendedBar')
                    bar.style.width = `${recommendedPercent * 4}px`
                    bar.textContent = `${recommendedPercent}%`
                },

                displayNotRecommendedBar() {
                    const { notRecommendedPercent } = methods.getRecommendationStats()
                    const bar = document.getElementById('notRecommendedBar')
                    bar.style.width = `${notRecommendedPercent * 4}px`
                    bar.textContent = `${notRecommendedPercent}%`
                },

                getRecommendationStats() {
                    const username = JSON.parse(localStorage.getItem('login_success'))?.username
                    const userBooks = JSON.parse(localStorage.getItem(`${username}Books`)) || []

                    const recommendedCount = userBooks.filter(book => book.torecommend === 'Yes').length
                    const notRecommendedCount = userBooks.filter(book => book.torecommend === 'No').length

                    const total = recommendedCount + notRecommendedCount || 1
                    const recommendedPercent = Math.round((recommendedCount / total) * 100)
                    const notRecommendedPercent = Math.round((notRecommendedCount / total) * 100)

                    return { recommendedPercent, notRecommendedPercent }
                },

            }

            const handlers = {


                onProgressSession() {
                    const user = JSON.parse(localStorage.getItem('login_success')) || false
                    if (!user) {
                        window.location.href = 'index.html'
                    }
                },

                logOutSession() {
                    alert('Good bye!')
                    localStorage.removeItem('login_success')
                    window.location.href = 'index.html'
                },

                onFormSubmit(e) {
                    e.preventDefault();
                    const title = htmlElements.form.title.value;
                    const author = htmlElements.form.author.value;
                    const date = htmlElements.form.date.value;
                    const pages = htmlElements.form.pages.value;
                    const torecommend = htmlElements.form.torecommend.value;

                    console.log(title)


                    if (title && author && date && pages && torecommend) {
                        methods.addBooks(title, author, date, pages, torecommend);
                    }
                }
            }

            return {
                init() {
                    handlers.onProgressSession()
                    htmlElements.tableContainer.innerHTML = methods.generateTable()
                    htmlElements.resp.classList.remove('hidden');
                    htmlElements.logout.addEventListener('click', handlers.logOutSession)
                    htmlElements.buttonShow.addEventListener('click', methods.openDialog)
                    htmlElements.buttonHide.addEventListener('click', methods.hideDialog)
                    methods.displayNotRecommendedBar()
                    methods.displayRecommendedBar()
                    methods.printUserName()
                    methods.getAverage()
                    methods.getTotalBooks()
                    htmlElements.form.addEventListener('submit', handlers.onFormSubmit)
                    methods.bindEvents()
                },
            }
        })();
        App.init()
    })();

</script>

</html>